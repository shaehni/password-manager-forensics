# Bitwarden Search Pattern Definition
This document defines the forensically relevant artefacts, and their structure, that can be found in files from the Bitwarden application directory and in a memory dump.

## data.json
This file stores configuration information as well as encrypted keys and vault data in JSON format. It is stored in `[application directory]/data.json`.

### Relevant Artefacts
- `['global']`
    - `['rememberedEmail']`: This element stores the last email address that was used to log into Bitwarden if the corresponding Box was ticked
- `['authenticatedAccounts']`: This element contains an array of all accounts that have been authenticated. Account IDs match the pattern `[a-z0-9]{8}-([a-z0-9]{4}-){3}[a-z0-9]{12}`.
- `['(accountID)']`
  - `['data']`
    - `['ciphers']['encrypted']`: This element contains a list of all vault items in encrypted format. Vault item IDs follow the same pattern as Account IDs (`[a-z0-9]{8}-([a-z0-9]{4}-){3}[a-z0-9]{12}`). See the chapter below for more details about encrypted vault data.
    - `['passwordGenerationHistory']['encrypted']`: This element contains an array of recently generated passwords (in encrypted format) as well as the time of creation. This information is not available through the GUI.
  - `['keys']`: This element contains a list of encrypted keys, namely the `cryptoSymmetricKey` and the `privateKey`. See the chapter below for more details about the key encryption format.
  - `['profile']`: This element includes a list with information about the user account, most notably the full name (`['name']`) and the account email (`['email']`). Furthermore, the number of `['kdfIterations']` needed to calculate the master key as well as the last time of vault synchronisation `['lastSync']` is available.
  - `['protectedPin']`: If a user has set a PIN with the option "Lock with master password on restart", this element contains the PIN code in the encrypted key format (see below).
  - `['pinProtected']['encrypted']`: If a user has set a PIN without the option "Lock with master password on restart", this element contains the master key encrypted with an encryption key derived from the PIN. This brings a potential for brute-forcing the master key if a weak PIN is set (see below).
  - `['passwordGenerationOptions']`: This element contains the settings last used for the password generator. This could be valuable information in case that vault data cannot be retrieved and brute-forcing of account passwords is necessary. If special characters are selected, only the following are used: `!@#$%^&*`

### Availability
The list of authenticated accounts as well as all data in the `['(accountID)']` element is available when the app is closed or the vault is locked. However, it gets purged when a users signs out. The remembered email stays available even after sign-out. The list of generated passwords is not stored on the server. It is permanently lost when a user signs out.

### Encrypted Vault Data
Bitwarden stores encrypted data as an what they call [encrypted string][1]. These encrypted strings have the following format: `(Encryption Type [int]).(Initiatlisation Vector [Base64])|(Encrypted Data [Base64])|(Message Authentication Code [Base64])`.

In all observed data, the encryption type was always `2`, which [corresponds][2] to `AesCbc256_HmacSha256_B64`.

Encrypted vault data can be matched by the following regex expression: `2\.[a-zA-Z0-9+\/]{22}={0,2}\|[a-zA-Z0-9+\/]+={0,2}\|[a-zA-Z0-9+\/]{43}={0,2}`

[1]: https://github.com/bitwarden/clients/blob/master/libs/common/src/models/domain/enc-string.ts
[2]: https://github.com/bitwarden/clients/blob/master/libs/common/src/enums/encryptionType.ts

### Encrypted Keys
Keys are encrypted the same way as encrypted vault data. While vault data is encrypted with the symmetric key, the stored symmetric key is encrypted with the expanded master key. The encryption key is generated by expanding the master key through HKDF with a salt of `enc`. The MAC is generated by expanding the master key through HKDF with a salt of `mac`.

The first 32 bytes of the symmetric vault key contain the encryption key. The second 32 bytes contain the MAC.

### Encrypted PIN
If the user has set a PIN and has disabled the option "Lock with master password on restart", the master key is encrypted with a key derived from the PIN and stored in the `data.json` file. This encryption key is calculated identically as the original (strechted) master key. In case a weak PIN is used, the master key can be brute-forced and the vault can be decrypted without knowledge of the master password.

***

## Memory
### Master Password
The master password appears in memory as part of the following string: `com.bitwarden.vault [account email address] [master password] -`

### Vault Passwords
Vault credentials (passwords) are stored in memory in a data structure with the format `CD 25 00 00 03 00 00 00 [XX] 00 00 00 [Password] [Random Bytes] CD 25` where `[XX]` indicates the lenght of the following string (possible password). Searching for this structure results in false positives. These are reduced by only considering strings that match the characters used by Bitwarden's password generator (`A-Za-z0-9!@#$%^&*`), and filtering out unlikely strings (<8 characters, only numbers, or only capital letters). Furthermore, strings that contain certain substrings that have been observed in false positives are filtered out.

